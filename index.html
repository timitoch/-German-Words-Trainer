<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>German Words Trainer 3.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>

<div class="container">


    <div id="upload-container">
        <div class="upload-area" id="upload-area">
            <p>üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ Excel (.xlsx) —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ</p>
            <small style="color: var(--text-light); margin-top: 10px; display: block;">
                –§–æ—Ä–º–∞—Ç: ID | –ù–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ | –ü–µ—Ä–µ–≤–æ–¥ | –ü—Ä–∏–º–µ—Ä
            </small>
        </div>
        
        <div class="file-input-container">
            <label for="file-input" class="file-input-button">
                üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
            </label>
            <input type="file" id="file-input" accept=".xlsx,.xls" />
        </div>
        
        <div class="gender-legend">
            <div class="gender-legend-item">
                <div class="gender-color-box masculine"></div>
                <span>der (–º—É–∂—Å–∫–æ–π)</span>
            </div>
            <div class="gender-legend-item">
                <div class="gender-color-box feminine"></div>
                <span>die (–∂–µ–Ω—Å–∫–∏–π)</span>
            </div>
            <div class="gender-legend-item">
                <div class="gender-color-box neuter"></div>
                <span>das (—Å—Ä–µ–¥–Ω–∏–π)</span>
            </div>
        </div>
    </div>

    <div id="trainer-container" class="hidden">
        <button id="back-btn" class="back-btn" title="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–ª–æ–≤–æ">‚Üê</button>
        <button id="reload-file-btn" class="reload-file-btn" title="–û–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª">üìÇ –û–±–Ω–æ–≤–∏—Ç—å</button>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="new-count">0</div>
                <div class="stat-label">–ù–æ–≤—ã—Ö —Å–ª–æ–≤ —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="due-count">0</div>
                <div class="stat-label">–ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="done-count">0</div>
                <div class="stat-label">–ò–∑—É—á–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
        </div>

        <div class="mastered-count" id="mastered-count">
            –û—Å–≤–æ–µ–Ω–æ: <span id="mastered-number">0</span>
        </div>

        <div id="card-container" class="card-container"></div>
        
        <div class="rating-buttons" id="rating-container">
            <button class="rating-btn rating-btn-1" data-rating="1">‚ùå –ù–µ –ø–æ–º–Ω—é<br><small>5 –º–∏–Ω—É—Ç</small></button>
            <button class="rating-btn rating-btn-2" data-rating="2">‚ö†Ô∏è –° —Ç—Ä—É–¥–æ–º<br><small>1 –¥–µ–Ω—å</small></button>
            <button class="rating-btn rating-btn-3" data-rating="3">üòê –ß–∞—Å—Ç–∏—á–Ω–æ<br><small>4 –¥–Ω—è</small></button>
            <button class="rating-btn rating-btn-4" data-rating="4">üôÇ –ü–æ—á—Ç–∏<br><small>7 –¥–Ω–µ–π</small></button>
            <button class="rating-btn rating-btn-5" data-rating="5">‚úÖ –ü–æ–º–Ω—é<br><small>12 –¥–Ω–µ–π</small></button>
            <button class="rating-btn rating-btn-6" data-rating="6">‚≠ê –û—Ç–ª–∏—á–Ω–æ<br><small>21 –¥–µ–Ω—å</small></button>
        </div>

        <div id="session-end" class="hidden session-end-message">
            <h2>üéâ –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
            <p>–í—ã –æ—Ç–ª–∏—á–Ω–æ –ø–æ—Ä–∞–±–æ—Ç–∞–ª–∏. –ó–∞–π–¥–∏—Ç–µ –ø–æ–∑–∂–µ, —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Å–ª–æ–≤–∞.</p>
            <button id="restart-btn" class="restart-btn">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
        </div>
    </div>
</div>

<script>
const uploadContainer = document.getElementById('upload-container');
const fileInput = document.getElementById('file-input');
const trainerContainer = document.getElementById('trainer-container');
const cardContainer = document.getElementById('card-container');
const ratingContainer = document.getElementById('rating-container');
const sessionEndElement = document.getElementById('session-end');
const restartBtn = document.getElementById('restart-btn');
const backBtn = document.getElementById('back-btn');
const reloadFileBtn = document.getElementById('reload-file-btn');
const newCountEl = document.getElementById('new-count');
const dueCountEl = document.getElementById('due-count');
const doneCountEl = document.getElementById('done-count');
const masteredNumberEl = document.getElementById('mastered-number');
const uploadArea = document.getElementById('upload-area');

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ drag & drop
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –æ–±–ª–∞—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏
uploadArea.addEventListener('click', () => {
    fileInput.click();
});

let fullDeck = [];
let sessionQueue = [];
let currentCard = null;
let isCardFlipped = false;
let cardHistory = [];
const DECK_KEY = 'german_words_deck_v3';
const DAILY_STATS_KEY = 'daily_stats_v3';
const MASTERED_KEY = 'mastered_words_v3';

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
    }
});

ratingContainer.addEventListener('click', handleRating);
restartBtn.addEventListener('click', () => {
    localStorage.removeItem(DECK_KEY);
    localStorage.removeItem(DAILY_STATS_KEY);
    location.reload();
});

backBtn.addEventListener('click', goToPreviousCard);
reloadFileBtn.addEventListener('click', () => {
    fileInput.click();
});

window.addEventListener('load', loadProgress);

function handleFile(file) {
    if (!file) return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
    if (!file.name.match(/\.(xlsx|xls)$/i)) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ Excel —Ñ–∞–π–ª (.xlsx –∏–ª–∏ .xls)');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            parseAndInitDeck(json);
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω.');
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ñ–∞–π–ª–∞:', error);
        }
    };
    reader.readAsArrayBuffer(file);
}

function parseAndInitDeck(data) {
    if (!data || data.length < 2) {
        alert('–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö.');
        return;
    }
    
    const newWords = data
        .slice(1)
        .filter(row => row && row[1] && row[2])
        .map(row => ({
            id: row[0] || Math.random().toString(36).substr(2, 9),
            german: row[1] || '',
            translation: row[2] || '',
            example: row[3] || '',
            interval: 0,
            easeFactor: 2.5,
            nextReviewDate: new Date().toISOString(),
            gender: detectGender(row[1] || '')
        }));
    
    if (newWords.length === 0) {
        alert('–í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.');
        return;
    }
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–ª–æ–≤–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö –ø—Ä–æ–≥—Ä–µ—Å—Å
    if (fullDeck.length > 0) {
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–ª–æ–≤ –ø–æ ID
        const existingWords = new Map();
        fullDeck.forEach(word => {
            existingWords.set(word.id, word);
        });
        
        // –û–±—ä–µ–¥–∏–Ω—è–µ–º –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏
        const mergedDeck = [];
        newWords.forEach(newWord => {
            const existingWord = existingWords.get(newWord.id);
            if (existingWord) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–ª–æ–≤–æ, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–≥—Ä–µ—Å—Å
                mergedDeck.push({
                    ...existingWord,
                    german: newWord.german,
                    translation: newWord.translation,
                    example: newWord.example,
                    gender: newWord.gender
                });
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–ª–æ–≤–æ
                mergedDeck.push(newWord);
            }
        });
        
        fullDeck = mergedDeck;
        alert(`–§–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω! –î–æ–±–∞–≤–ª–µ–Ω–æ ${newWords.length - existingWords.size} –Ω–æ–≤—ã—Ö —Å–ª–æ–≤.`);
    } else {
        fullDeck = newWords;
    }
    
    saveProgress();
    startSession();
}

function detectGender(germanWord) {
    if (!germanWord) return null;
    
    const word = germanWord.trim().toLowerCase();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä—Ç–∏–∫–ª–∏ –≤ –Ω–∞—á–∞–ª–µ —Å–ª–æ–≤–∞
    if (word.startsWith('der ')) {
        return 'masculine';
    } else if (word.startsWith('die ')) {
        return 'feminine';
    } else if (word.startsWith('das ')) {
        return 'neuter';
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä—Ç–∏–∫–ª–∏ –≤ —Å–∫–æ–±–∫–∞—Ö –∏–ª–∏ —á–µ—Ä–µ–∑ –¥–µ—Ñ–∏—Å
    if (word.includes('(der)') || word.includes('- der')) {
        return 'masculine';
    } else if (word.includes('(die)') || word.includes('- die')) {
        return 'feminine';
    } else if (word.includes('(das)') || word.includes('- das')) {
        return 'neuter';
    }
    
    return null; // –ï—Å–ª–∏ —Ä–æ–¥ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null
}

function saveProgress() {
    if (fullDeck.length > 0) {
        localStorage.setItem(DECK_KEY, JSON.stringify(fullDeck));
    }
}

function loadProgress() {
    const savedDeck = localStorage.getItem(DECK_KEY);
    if (savedDeck) {
        fullDeck = JSON.parse(savedDeck);
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–¥–∞ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        fullDeck = fullDeck.map(card => {
            if (!card.gender) {
                card.gender = detectGender(card.german);
            }
            return card;
        });
        if (fullDeck.length > 0) {
            startSession();
        }
    }
}

function getTodayStats() {
    const today = new Date().toDateString();
    const saved = localStorage.getItem(DAILY_STATS_KEY);
    let stats = saved ? JSON.parse(saved) : {};
    
    if (!stats[today]) {
        stats[today] = { done: 0 };
    }
    
    return stats[today];
}

function updateTodayStats(increment = 1) {
    const today = new Date().toDateString();
    const saved = localStorage.getItem(DAILY_STATS_KEY);
    let stats = saved ? JSON.parse(saved) : {};
    
    if (!stats[today]) {
        stats[today] = { done: 0 };
    }
    
    stats[today].done += increment;
    localStorage.setItem(DAILY_STATS_KEY, JSON.stringify(stats));
    
    return stats[today];
}

function startSession() {
    uploadContainer.classList.add('hidden');
    trainerContainer.classList.remove('hidden');
    sessionEndElement.classList.add('hidden');
    
    const now = new Date();
    const dueCards = fullDeck.filter(card => new Date(card.nextReviewDate) <= now);
    const newCards = fullDeck.filter(card => card.interval === 0 && new Date(card.nextReviewDate) <= now);
    
    sessionQueue = dueCards.sort(() => Math.random() - 0.5);
    cardHistory = [];
    
    const todayStats = getTodayStats();
    
    const stats = {
        new: newCards.length,
        due: dueCards.length - newCards.length,
        done: todayStats.done
    };
    
    window.sessionStats = stats;
    updateStatsUI();
    updateMasteredCount();
    
    if (sessionQueue.length > 0) {
        nextCard();
    } else {
        endSession();
    }
}

function updateStatsUI() {
    newCountEl.textContent = window.sessionStats.new;
    dueCountEl.textContent = window.sessionStats.due;
    doneCountEl.textContent = window.sessionStats.done;
}

function nextCard() {
    if (sessionQueue.length === 0) {
        endSession();
        return;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É –≤ –∏—Å—Ç–æ—Ä–∏—é
    if (currentCard) {
        cardHistory.push(currentCard);
    }
    
    currentCard = sessionQueue.shift();
    isCardFlipped = false;
    updateBackButton();
    displayCard();
}

function goToPreviousCard() {
    if (cardHistory.length === 0) return;
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É –≤ –Ω–∞—á–∞–ª–æ –æ—á–µ—Ä–µ–¥–∏
    if (currentCard) {
        sessionQueue.unshift(currentCard);
    }
    
    // –ë–µ—Ä–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
    currentCard = cardHistory.pop();
    isCardFlipped = false;
    updateBackButton();
    displayCard();
}

function updateBackButton() {
    backBtn.disabled = cardHistory.length === 0;
}

function displayCard() {
    ratingContainer.classList.remove('hidden');
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –æ–∫—Ä–∞—Å–∫–∏ —Å–ª–æ–≤–∞
    let genderClass = '';
    if (currentCard.gender === 'masculine') {
        genderClass = 'masculine';
    } else if (currentCard.gender === 'feminine') {
        genderClass = 'feminine';
    } else if (currentCard.gender === 'neuter') {
        genderClass = 'neuter';
    }
    
    cardContainer.innerHTML = `
        <div class="card-inner" id="card-inner">
            <div class="card-face card-front">
                <div class="german-word ${genderClass}">${currentCard.german}</div>
                ${currentCard.example ? `<div class="example">${currentCard.example}</div>` : ''}
            </div>
            <div class="card-face card-back">
                <div class="translation">${currentCard.translation}</div>
            </div>
        </div>
    `;
    
    document.getElementById('card-inner').addEventListener('click', flipCard);
}

function flipCard() {
    const cardInner = document.getElementById('card-inner');
    
    if (!isCardFlipped) {
        cardInner.classList.add('is-flipped');
        isCardFlipped = true;
    } else {
        cardInner.classList.remove('is-flipped');
        isCardFlipped = false;
    }
}

function handleRating(event) {
    if (!event.target.matches('.rating-btn')) return;

    const rating = parseInt(event.target.dataset.rating, 10);
    const isNew = currentCard.interval === 0;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—Å–≤–æ–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤
    if (rating >= 5) {
        updateMasteredWords(currentCard.id, rating);
    }

    updateCardInterval(rating);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    const updatedStats = updateTodayStats(1);
    window.sessionStats.done = updatedStats.done;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–µ—Å—Å–∏–∏
    if (isNew) {
        window.sessionStats.new = Math.max(0, window.sessionStats.new - 1);
    } else {
        window.sessionStats.due = Math.max(0, window.sessionStats.due - 1);
    }

    updateStatsUI();
    updateMasteredCount();
    saveProgress();
    
    setTimeout(() => {
        nextCard();
    }, 300);
}

function updateCardInterval(rating) {
    const MIN_EASE = 1.3;
    let { easeFactor, interval } = currentCard;
    
    if (rating < 3) {
        interval = 0;
        easeFactor = Math.max(MIN_EASE, easeFactor - 0.2);
        sessionQueue.push(currentCard);
    } else {
        if (interval === 0) {
            interval = 1;
        } else if (interval === 1) {
            interval = 4;
        } else {
            interval = Math.round(interval * easeFactor);
        }
        easeFactor = easeFactor + (0.1 - (6 - rating) * (0.08 + (6 - rating) * 0.02));
        if (easeFactor < MIN_EASE) easeFactor = MIN_EASE;
    }
    
    currentCard.interval = interval;
    currentCard.easeFactor = easeFactor;
    
    const now = new Date();
    const nextReview = (interval > 0)
        ? new Date(now.getTime() + interval * 24 * 60 * 60 * 1000)
        : new Date(now.getTime() + 5 * 60 * 1000);
    
    currentCard.nextReviewDate = nextReview.toISOString();
}

function previewNextReviewDate(card, rating) {
    const MIN_EASE = 1.3;
    let easeFactor = card.easeFactor || 2.5;
    let interval = card.interval || 0;

    if (rating < 3) {
        return new Date(Date.now() + 5 * 60 * 1000);
    }

    if (interval === 0) {
        interval = 1;
    } else if (interval === 1) {
        interval = 4;
    } else {
        interval = Math.round(interval * easeFactor);
    }

    return new Date(Date.now() + interval * 24 * 60 * 60 * 1000);
}

function updateMasteredWords(cardId, rating) {
    const now = new Date();
    const saved = localStorage.getItem(MASTERED_KEY);
    let mastered = saved ? JSON.parse(saved) : {};
    
    if (rating === 5) {
        // –ü–æ–º–Ω—é - 12 –¥–Ω–µ–π
        mastered[cardId] = {
            expires: new Date(now.getTime() + 12 * 24 * 60 * 60 * 1000).toISOString(),
            rating: 5
        };
    } else if (rating === 6) {
        // –û—Ç–ª–∏—á–Ω–æ - 21 –¥–µ–Ω—å
        mastered[cardId] = {
            expires: new Date(now.getTime() + 21 * 24 * 60 * 60 * 1000).toISOString(),
            rating: 6
        };
    }
    
    localStorage.setItem(MASTERED_KEY, JSON.stringify(mastered));
}

function updateMasteredCount() {
    const now = new Date();
    const saved = localStorage.getItem(MASTERED_KEY);
    let mastered = saved ? JSON.parse(saved) : {};
    
    // –£–¥–∞–ª—è–µ–º –∏—Å—Ç–µ–∫—à–∏–µ –∑–∞–ø–∏—Å–∏
    for (const [cardId, data] of Object.entries(mastered)) {
        if (new Date(data.expires) <= now) {
            delete mastered[cardId];
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    localStorage.setItem(MASTERED_KEY, JSON.stringify(mastered));
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
    const count = Object.keys(mastered).length;
    masteredNumberEl.textContent = count;
}

function endSession() {
    trainerContainer.classList.add('hidden');
    uploadContainer.classList.add('hidden');
    sessionEndElement.classList.remove('hidden');
}
</script>

</body>
</html>